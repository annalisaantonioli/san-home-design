{% if linklists.gift-wrapping.links.size > 0 and linklists.gift-wrapping.links.first.type == 'product_link' %}
  <div id="is-a-gift" class="clearfix rte">
    {% for variant in linklists.gift-wrapping.links.first.object.variants %}
    <p>
      <input type="hidden" name="attributes[gift-wrapping]" data-variantId="{{ variant.id }}" value="" />
      <input id="gift-wrapping" type="checkbox" name="attributes[gift-wrapping]" data-variantId="{{ variant.id }}" value="yes" {% for item in cart.items %}{% if item.id == variant.id %} checked="checked"{% endif %}{% endfor %} style="float: none" />
      {{ variant.image.src }}
      <label for="gift-wrapping" style="display:inline; padding-left: 5px; float: none;">
      For {{ variant.price | money }} please wrap the products in this order.
      </label>
    </p>
    {% endfor %}
    <p>
      <label style="display:block" for="gift-note">Gift message (free and optional):</label>
      <textarea name="attributes[gift-note]" id="gift-note">{{ cart.attributes.gift-note }}</textarea>
    </p>
  </div>

{% assign id = linklists.gift-wrapping.links.first.object.variants.first.id %}

{% assign gift_wraps_in_cart = 0 %}
{% for item in cart.items %}
  {% if item.id == id %}
    {% assign gift_wraps_in_cart = item.quantity %}
  {% endif %}
{% endfor %}

<style>
  #updates_{{ id }} { display: none; }
</style>

<script>

var variantList = [],
    giftObj = {};

{% for variant in linklists.gift-wrapping.links.first.object.variants %}
    variantList.push({{variant.id}});
{% endfor %}

Shopify.Cart = Shopify.Cart || {};

Shopify.Cart.GiftWrap = {};

Shopify.Cart.GiftWrap.set = function(obj, selectedItem) {
    var headers = new Headers({ 'Content-Type': 'application/json' });
      var request = {
      method: 'POST',
      headers: headers,
      body: JSON.stringify({ updates: obj  })
    };
    fetch('/cart/update.js', request)
    .then(function() {
      location.href = '/cart';
    });
  /*jQuery.ajax({
    type: 'POST',
    url: '/cart/update.js',
    data: { updates: obj },
    dataType: 'json',
    success: function() { location.href = '/cart'; }
  });*/
}

Shopify.Cart.GiftWrap.remove = function(obj) {
 /* jQuery.ajax({
    type: 'POST',
    url: '/cart/update.js',
    data: { updates: obj },
    dataType: 'json',
    success: function() { location.href = '/cart'; }
  });*/
    var headers = new Headers({ 'Content-Type': 'application/json' });
      var request = {
      method: 'POST',
      headers: headers,
      body: JSON.stringify({ updates: obj  })
    };
    fetch('/cart/update.js', request)
    .then(function() {
      location.href = '/cart';
    });
}

{% if cart.items.size == 1 and gift_wraps_in_cart > 0 %}
    document.addEventListener("DOMContentLoaded", function(){
       Shopify.Cart.GiftWrap.remove();
});
{% endif %}

// When the gift-wrapping checkbox is checked or unchecked.
  
    document.addEventListener("DOMContentLoaded", function(){
      const items = document.querySelectorAll('[name="attributes[gift-wrapping]"]')
      items.forEach(item => {(
            item.addEventListener("change", function() {
    var selectedItem = item.getAttribute("data-variantId");

    function createObjectQuntity(element, index, array) {
      if( element == selectedItem) {
        giftObj[element] = 1;
      } else {
        giftObj[element] = 0;
      }
    }

              

    if (item.checked) {
      variantList.forEach(createObjectQuntity);
      Shopify.Cart.GiftWrap.set(giftObj, selectedItem);
    }
    else {
      selectedItem = 0;
      variantList.forEach(createObjectQuntity);
      Shopify.Cart.GiftWrap.remove(giftObj);
    }
  });
      )})


});

</script>

{% else %}

<p style="clear: left; margin: 30px 0" class="rte">
  You attempted to add a gift-wrapping script to your shopping cart, but it won't work because you don't have
  a link list with handle <code>gift-wrapping</code> which, in turn, contains a link
  to your gift-wrapping product. Please review the steps outlined
  <a href="http://docs.shopify.com/manual/configuration/store-customization/page-specific/cart-page/add-a-gift-wrap-option">here</a>.
</p>

{% endif %}